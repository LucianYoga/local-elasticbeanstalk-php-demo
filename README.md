# Local Elastic Beanstalk PHP Demo

This is a demonstration of running multiple containers locally using Amazon's Elastic Beanstalk.

In truth, all Elastic Beanstalk will be doing for us here will be generating a `docker-compose.yml`
file (in `.elasticbeanstalk`), but once we're happy with the results, we can easily use the same
configuration to run our containers on AWS usng Elastic Beanstalk.

We want to be able to:

* Install and use Docker on Mac OSX
* Build a custom Docker image using a `Dockerfile`, fully provisioned and ready for our app
* Run up containers locally from the Docker image using Elastic Beanstalk's `eb local run`

Our app will do nothing more arduous than displaying the information generated by `phpinfo()`.

Note that our Docker image will not contain our app, as we want to be able to reuse the same image
for future revisions of our app. If our app was bundled into the image, we'd need to rebuild the
Docker image each time our app was revised, rather than simply starting up new containers.

Additional notes are to be found at:

* https://github.com/hopsoft/relay/wiki/How-to-Deploy-Docker-apps-to-Elastic-Beanstalk
* http://www.sitepoint.com/docker-and-dockerfiles-made-easy/
* http://www.michaelgallego.fr/blog/2015/07/18/using-elastic-beanstalk-multi-container-with-php/


## Installation

We use `docker-machine` on OSX via the [Docker ToolBox](https://www.docker.com/products/docker-toolbox).
As we're using Max OSX, this means that we'll end up with a Virtualbox Linux VM that will be used to run Docker.

Once installed, we can see that `docker` is at version 10.1:

    docker -v
    $ Docker version 1.10.2, build c3959b1

Start our `docker-machine`:

    docker-machine start default

Port-forward in `VirtualBox`, so we can access port 80 transparently:

    VBoxManage list vms
    VBoxManage modifyvm "defaut" --natpf1 "guestnginx,tcp,,80,,80"

Set our environment variables:

    docker-machine config default

    export DOCKER_CERT_PATH=/Users/whoever/.docker/machine/certs
    export DOCKER_TLS_VERIFY=1
    export DOCKER_HOST=tcp://192.168.99.100:2376

Load the environment so we can use docker from the local shell:

    eval "$(docker-machine env default)"


## Install `awsebcli`

We install the `awsebcli` using homebrew:

    brew install awsebcli

However, [there's a problem with the version compatibility check](https://forums.aws.amazon.com/thread.jspa?threadID=225425), meaning that awsebcli thinks that docker 1.10.2 is < docker 1.6, and we receive the following message:

    "You must install Docker version 1.6.0 to continue. If you are using Mac OS X, ensure you have boot2docker version 1.6.0. Currently, "eb local" does not support Windows."

To rectify this, currently we must edit `/usr/local/Cellar/aws-elasticbeanstalk/3.7.3/libexec/lib/python2.7/site-packages/ebcli/containers/compat.py` as follows, by changing:

    def supported_docker_installed():
        """
        Return whether proper Docker version is installed.
        :return: bool
        """

        try:
            return commands.version() >= SUPPORTED_DOCKER_V
        # OSError = Not installed
        # CommandError = docker versions less than 1.5 give exit code 1
        # with 'docker --version'.
        except (OSError, CommandError):
            return False

to

    def supported_docker_installed():
        """
        Return whether proper Docker version is installed.
        :return: bool
        """

        try:
            #return commands.version() >= SUPPORTED_DOCKER_V
            return True
        # OSError = Not installed
        # CommandError = docker versions less than 1.5 give exit code 1
        # with 'docker --version'.
        except (OSError, CommandError):
            return False


## Building our Docker image

Build our docker image:

    cd production
    docker build -t mebooks/apache-php5 .


## Create our `Dockerrun.aws.json`

Now, we need to initialise our `.elasticbeanstalk/config.yml`:

    eb init

Note that we specify a (very) weak `MYSQL_ROOT_PASSWORD` in our `Dockerrun.aws.json` -- you'll want to change this
and not have it under version control.


## Run our containers locally

Finally, use `eb local` to create our docker containers locally:

    eb local run

Alternatively, we can start the containers directly:

    # Start just the PHP container
    docker run -tid -p 80:80 mebooks/apache-php5

    # Start both containers linked
    docker run -p 3306:3306 --name mysqlserver -e MYSQL_ROOT_PASSWORD=password -e MYSQL_DATABASE=my_db -d mysql
    docker run -tid -p 80:80 -v ~/workspace/eb-demo-php/php-app:/var/www/html --name apache-php5-app --link mysqlserver:mysqldb mebooks/apache-php5

We should now be able to see the Ubuntu welcome page at the address reported by `docker-machine ip`

    docker-machine ip
    # http://192.168.99.100/


## Accessing the containers

Find the appropriate container id, and start a bash shell on it:

    docker ps

    CONTAINER ID        IMAGE
    832af3ff45d8        mebooks/apache-php5:latest
    fc6a9553583f        mysql:5.6

    # Access our PHP container
    docker exec -it 832af3ff45d8 bash

    # check our apache config
    apachectl configtest

    # view our apache config
    cat /etc/apache2/sites-enabled/vhost.conf

    # Access our MySql container
    docker exec -it fc6a9553583f bash

    # Display our databases -- we should see my_db
    mysql -u root -p -e "show databases;"

# Cleaning up

Once we're finished, remove our containers

    docker rm 832af3ff45d8
    docker rm fc6a9553583f

If we're finished with our image, we can delete it:

    docker rmi mebooks/apache-php5
